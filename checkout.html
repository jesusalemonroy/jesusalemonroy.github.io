<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>PixelShop - Carrito</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-4">
  <h2>Carrito de Compras</h2>
  <table class="table">
    <thead>
      <tr>
        <th>Producto</th>
        <th>Precio</th>
        <th>Cantidad</th>
        <th>Total</th>
        <th>Acción</th>
      </tr>
    </thead>
    <tbody id="cart-body"></tbody>
  </table>

  <h4 id="cart-total">Total: $0</h4>

  <button class="btn btn-success" id="confirm-btn">Confirmar Compra</button>
  <button class="btn btn-danger" id="cancel-btn">Cancelar Compra</button>

  <hr>
  <h5>Estado de la compra: <span id="order-status">Sin confirmar</span></h5>

  <a href="index.html" class="btn btn-secondary mt-3">Seguir comprando</a>
  <a href="orders.html" class="btn btn-primary mt-3">Historial de compras</a>
</div>

<script>
let currentUser = localStorage.getItem("currentUser");
if(!currentUser){
  alert("Debes iniciar sesión para ver el carrito");
  window.location.href = "login.html";
}

let cart = JSON.parse(localStorage.getItem("cart")) || [];
const cartBody = document.getElementById("cart-body");
const cartTotal = document.getElementById("cart-total");
const orderStatus = document.getElementById("order-status");

function renderCart(){
  cartBody.innerHTML = "";
  let total = 0;
  cart.forEach((item,index)=>{
    let subtotal = item.price*item.quantity;
    total+=subtotal;
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${item.name}</td>
      <td>$${item.price}</td>
      <td>${item.quantity}</td>
      <td>$${subtotal}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removeItem(${index})">Eliminar</button></td>
    `;
    cartBody.appendChild(row);
  });
  cartTotal.textContent = `Total: $${total}`;
}

function removeItem(index){
  cart.splice(index,1);
  localStorage.setItem("cart",JSON.stringify(cart));
  renderCart();
}

function confirmOrder(){
  if(cart.length===0) return alert("Carrito vacío");

  let orders = JSON.parse(localStorage.getItem("orders")) || [];
  let newOrder = {
    user: currentUser,
    items: cart,
    total: cart.reduce((sum,i)=>sum+i.price*i.quantity,0),
    status: "pendiente",
    date: new Date().toLocaleString()
  };
  orders.push(newOrder);
  localStorage.setItem("orders",JSON.stringify(orders));

  localStorage.removeItem("cart");
  cart = [];
  renderCart();

  orderStatus.textContent="pendiente";
  alert("Compra confirmada. Estado: pendiente");

  setTimeout(()=>{
    let savedOrders = JSON.parse(localStorage.getItem("orders")) || [];
    let lastOrder = savedOrders[savedOrders.length-1];
    if(lastOrder && lastOrder.status==="pendiente"){
      lastOrder.status="enviado";
      localStorage.setItem("orders",JSON.stringify(savedOrders));
      orderStatus.textContent="enviado";
    }
  },5*60*1000);
}

function cancelOrder(){
  let orders = JSON.parse(localStorage.getItem("orders")) || [];
  let lastOrder = orders[orders.length-1];
  if(lastOrder && lastOrder.status==="pendiente"){
    lastOrder.status="cancelado";
    localStorage.setItem("orders",JSON.stringify(orders));
    orderStatus.textContent="cancelado";
    alert("Compra cancelada");
  } else {
    alert("No se puede cancelar. Pedido enviado o inexistente");
  }
}

document.getElementById("confirm-btn").addEventListener("click",confirmOrder);
document.getElementById("cancel-btn").addEventListener("click",cancelOrder);

renderCart();
</script>
</body>
</html>
